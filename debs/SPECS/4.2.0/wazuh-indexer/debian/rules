#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
#
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

# TODO: Check why it uses tmp
#export TARGET_DIR=${CURDIR}/debian/wazuh-indexer
export TARGET_DIR=${CURDIR}/debian/tmp

# Package build options
export INSTALLATION_DIR="/usr/share/wazuh-indexer"
export INSTALLATION_SCRIPTS_DIR="${INSTALLATION_DIR}/packages_files/agent_installation_scripts"
export JOBS="5"
export DEBUG_ENABLED="no"
export PATH="${PATH}"
export LD_LIBRARY_PATH=""

# My variables
export USER=wazuh-indexer
export GROUP=wazuh-indexer
export SERVICE_NAME=wazuh-indexer
export CONFIG_DIR=/etc/${SERVICE_NAME}
export LOG_DIR=/var/log/${SERVICE_NAME}
export LIB_DIR=/var/lib/${SERVICE_NAME}
export PID_DIR=/var/run/${SERVICE_NAME}
export INSTALL_DIR=/usr/share/${SERVICE_NAME}

%:
	dh $@

override_dh_shlibdeps:

override_dh_auto_configure:

override_dh_auto_install:

override_dh_install:

	rm -rf $(INSTALLATION_DIR)/


	mkdir -p files/plugins
	mkdir -p files/config_files
	curl -o files/opendistroforelasticsearch-1.13.1-linux-x64.tar.gz https://packages-dev.wazuh.com/deps/wazuh-indexer/opendistroforelasticsearch-1.13.1-linux-x64.tar.gz
	curl -o files/elasticsearch-oss-extracted-files.tgz https://packages-dev.wazuh.com/deps/wazuh-indexer/elasticsearch-oss-extracted-files.tgz
	tar -zxvf files/elasticsearch-oss-extracted-files.tgz -C files/


	curl -o files/wazuh-cert-tool.sh https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/tools/certificate-utility/wazuh-cert-tool.sh
	curl -o files/instances.yml https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/tools/certificate-utility/instances_aio.yml
	#Using only AIO for the moment
	#curl -o files/instances.yml https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/tools/certificate-utility/instances.yml
	curl -o files/wazuh-passwords-tool.sh https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/tools/wazuh-passwords-tool.sh


	curl -o files/config_files/elasticsearch.yml  https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/elasticsearch/7.x/elasticsearch.yml
	curl -o files/config_files/elasticsearch_all_in_one.yml  https://raw.githubusercontent.com/wazuh/wazuh-documentation/679-wazuh-packages_wazuh-indexer/resources/open-distro/elasticsearch/7.x/elasticsearch_all_in_one.yml

	curl -o files/config_files/roles.yml https://raw.githubusercontent.com/wazuh/wazuh-documentation/4.1/resources/open-distro/elasticsearch/roles/roles.yml
	curl -o files/config_files/roles_mapping.yml https://raw.githubusercontent.com/wazuh/wazuh-documentation/4.1/resources/open-distro/elasticsearch/roles/roles_mapping.yml
	curl -o files/config_files/internal_users.yml https://raw.githubusercontent.com/wazuh/wazuh-documentation/4.1/resources/open-distro/elasticsearch/roles/internal_users.yml

	curl -o files/opendistro-performance-analyzer.service https://packages-dev.wazuh.com/deps/wazuh-indexer/opendistro-performance-analyzer.service
	

	tar -zvxf files/opendistroforelasticsearch-1.13.1-linux-x64.tar.gz

	# Fix distribution type so systemd is notified: https://github.com/elastic/elasticsearch/issues/55477
	sed -i 's/ES_DISTRIBUTION_TYPE=tar/ES_DISTRIBUTION_TYPE=rpm/' opendistroforelasticsearch-1.13.1/bin/elasticsearch-env


	# copy to target

	#mkdir -p $(TARGET_DIR)%{_initrddir}
	mkdir -p $(TARGET_DIR)$(INSTALLATION_DIR)
	mkdir -p $(TARGET_DIR)$(CONFIG_DIR)/certs
	mkdir -p $(TARGET_DIR)$(CONFIG_DIR)/jvm.options.d
	mkdir -p $(TARGET_DIR)/etc/init.d
	mkdir -p $(TARGET_DIR)/etc/sysconfig
	mkdir -p $(TARGET_DIR)/usr/lib/tmpfiles.d
	mkdir -p $(TARGET_DIR)/usr/lib/sysctl.d
	mkdir -p $(TARGET_DIR)/usr/lib/systemd/system
	mkdir -p $(TARGET_DIR)$(LIB_DIR)
	mkdir -p $(TARGET_DIR)$(LOG_DIR)

	# Copy the installed files into buildroot directory
	cp -pr opendistroforelasticsearch-1.13.1/* $(TARGET_DIR)$(INSTALLATION_DIR)/

	# Add custom tools
	cp files/wazuh-passwords-tool.sh $(TARGET_DIR)$(INSTALLATION_DIR)/bin
	cp files/wazuh-cert-tool.sh $(TARGET_DIR)$(INSTALLATION_DIR)/bin
	cp files/instances.yml $(TARGET_DIR)$(INSTALLATION_DIR)/bin

	# Copy the different versions of elasticsearch.yml (varying depending on the
	# deployment type (AIO or distributed) and cert tool used.
	cp files/config_files/elasticsearch.yml $(TARGET_DIR)$(CONFIG_DIR)/elasticsearch.yml.distributed
	cp files/config_files/elasticsearch_all_in_one.yml $(TARGET_DIR)$(CONFIG_DIR)/elasticsearch.yml.aio
	cp files/config_files/elasticsearch_all_in_one.yml $(TARGET_DIR)$(CONFIG_DIR)/elasticsearch.yml



	# Copy configuration files
	cp files/elasticsearch-oss-extracted-files/etc/init.d/$(SERVICE_NAME) $(TARGET_DIR)/etc/init.d/$(SERVICE_NAME)
	cp files/elasticsearch-oss-extracted-files/etc/wazuh-indexer/log4j2.properties $(TARGET_DIR)$(CONFIG_DIR)/log4j2.properties
	cp files/elasticsearch-oss-extracted-files/etc/wazuh-indexer/jvm.options $(TARGET_DIR)$(CONFIG_DIR)/jvm.options
	cp files/elasticsearch-oss-extracted-files/etc/sysconfig/$(SERVICE_NAME) $(TARGET_DIR)/etc/sysconfig/$(SERVICE_NAME)
	cp files/elasticsearch-oss-extracted-files/usr/lib/tmpfiles.d/$(SERVICE_NAME).conf $(TARGET_DIR)/usr/lib/tmpfiles.d/$(SERVICE_NAME).conf
	cp files/elasticsearch-oss-extracted-files/usr/lib/sysctl.d/$(SERVICE_NAME).conf $(TARGET_DIR)/usr/lib/sysctl.d/$(SERVICE_NAME).conf
	cp files/elasticsearch-oss-extracted-files/usr/lib/systemd/system/$(SERVICE_NAME).service $(TARGET_DIR)/usr/lib/systemd/system/$(SERVICE_NAME).service
	cp files/elasticsearch-oss-extracted-files/systemd-entrypoint $(TARGET_DIR)$(INSTALLATION_DIR)/bin
	cp -pr files/elasticsearch-oss-extracted-files/systemd_module/systemd $(TARGET_DIR)$(INSTALLATION_DIR)/modules

	# This is needed by the performance-analyzer service
	echo false > $(TARGET_DIR)$(INSTALLATION_DIR)/data/batch_metrics_enabled.conf

	# Service for performance analyzer
	cp files/opendistro-performance-analyzer.service $(TARGET_DIR)/usr/lib/systemd/system/


	# Install plugins
	export ES_HOME=$(TARGET_DIR)$(INSTALLATION_DIR)
	export JAVA_HOME=$(TARGET_DIR)$(INSTALLATION_DIR)/jdk

	# Run the opendistro tar install script but don't start elasticsearch at this time
	sed -i 's/bash $$ES_HOME/#bash $$ES_HOME/' $(TARGET_DIR)$(INSTALLATION_DIR)/opendistro-tar-install.sh

	cat $(TARGET_DIR)$(INSTALLATION_DIR)/opendistro-tar-install.sh

	# realpath is not present in docker image but readlink is
	sed -i 's/realpath/readlink -f/' $(TARGET_DIR)$(INSTALLATION_DIR)/opendistro-tar-install.sh

	$(TARGET_DIR)$(INSTALLATION_DIR)/opendistro-tar-install.sh


	# Copy Wazuh's config files for the opendistro_security plugin
	cp -pr files/config_files/roles_mapping.yml $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/opendistro_security/securityconfig/roles_mapping.yml
	cp -pr files/config_files/roles.yml $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/opendistro_security/securityconfig/roles.yml
	cp -pr files/config_files/internal_users.yml $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/opendistro_security/securityconfig/internal_users.yml

	# Fix file sourced file by elasticsearch-env so that it can find the config directory as /etc/elasticsearch
	# https://github.com/elastic/elasticsearch/blob/v7.10.2/distribution/src/bin/elasticsearch-env#L81
	# https://github.com/elastic/elasticsearch/blob/v7.10.2/distribution/build.gradle#L585
	sed -i 's/if \[ -z "$$ES_PATH_CONF" \]; then ES_PATH_CONF="$$ES_HOME"\/config; fi/source \/etc\/sysconfig\/wazuh-indexer/' $(TARGET_DIR)$(INSTALLATION_DIR)/bin/elasticsearch-env

	# Remove bundled configuration directory since /etc/wazuh-indexer will be used
	rm -rf $(TARGET_DIR)$(INSTALLATION_DIR)/config

	# Fix performance-analyzer plugin files which reference elasticsearch path
	# Note: For the moment not using variable because of escaped slashes, btu should use INSTALL_DIR
	sed -i 's/\/usr\/share\/elasticsearch/\/usr\/share\/wazuh-indexer/' $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/opendistro-performance-analyzer/pa_config/supervisord.conf
	sed -i 's/\/usr\/share\/elasticsearch/\/usr\/share\/wazuh-indexer/' $(TARGET_DIR)$(INSTALLATION_DIR)/plugins/opendistro-performance-analyzer/performance-analyzer-rca/pa_config/supervisord.conf


#override_dh_auto_clean:
	#$(MAKE) -C src clean


override_dh_strip:
	dh_strip --no-automatic-dbgsym

.PHONY: override_dh_strip override_dh_auto_clean override_dh_auto_build override_dh_auto_configure
